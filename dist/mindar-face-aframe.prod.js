(()=>{"use strict";const e="mindar-face-system",t="mindar-face-default-face-occluder",i="camera",s="mesh",a="arError",n=e=>null==e;AFRAME.registerComponent("mindar-face",{dependencies:[e],el:null,schema:{autoStart:{type:"boolean",default:!0},faceOccluder:{type:"boolean",default:!0},uiLoading:{type:"string",default:"yes"},uiScanning:{type:"string",default:"yes"},uiError:{type:"string",default:"yes"},filterMinCF:{type:"number",default:-1},filterBeta:{type:"number",default:-1},shouldFaceUser:{type:"boolean",default:!0},_positionSettings:{type:"string",default:"absolute"},_positionZIndex:{type:"int",default:-2},faceMeshPath:{type:"string",default:"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/"}},init:function(){if(!this.el.sceneEl)return;const e=this.el.sceneEl.systems["mindar-face-system"];if(this.data.faceOccluder){const e=document.createElement("a-entity");e.setAttribute(t,!0),this.el.sceneEl.appendChild(e)}e.setup({uiLoading:this.data.uiLoading,uiScanning:this.data.uiScanning,uiError:this.data.uiError,filterMinCF:-1===this.data.filterMinCF?null:this.data.filterMinCF,filterBeta:-1===this.data.filterBeta?null:this.data.filterBeta,shouldFaceUser:this.data.shouldFaceUser,_positionSettings:this.data._positionSettings,_positionZIndex:this.data._positionZIndex,faceMeshPath:this.data.faceMeshPath}),this.data.autoStart&&this.el.sceneEl.addEventListener("renderstart",(()=>{e.start()}))}}),AFRAME.registerComponent(t,{el:null,init:function(){this.el.sceneEl&&(this.el.sceneEl.systems["mindar-face-system"].registerFaceMesh(this),this.el.object3D.matrixAutoUpdate=!1)},updateVisibility(e){this.el.object3D.visible=e},updateMatrix(e){e&&this.el.object3D.matrix.set(...e)},addFaceMesh(e){const t=new AFRAME.THREE.MeshBasicMaterial({colorWrite:!1}),i=new AFRAME.THREE.Mesh(e,t);this.el.setObject3D(s,i)}}),AFRAME.registerComponent("mindar-face-occluder",{el:null,init:function(){this.el.addEventListener("model-loaded",this.onModelLoaded.bind(this)),this.el.addEventListener("model-error",this.onModelError.bind(this))},onModelLoaded:function(){this.el.getObject3D(s).traverse((e=>{if(e.isMesh){const t=new AFRAME.THREE.MeshStandardMaterial({colorWrite:!1});e.material=t}}))},onModelError:function(){console.warn("Model failed to load.")}}),AFRAME.registerComponent("mindar-face-target",{dependencies:[e],el:null,schema:{anchorIndex:{type:"number"}},init:function(){if(!this.el.sceneEl)return;this.el.sceneEl.systems["mindar-face-system"].registerAnchor(this,this.data.anchorIndex);const e=this.el.object3D;e.visible=!1,e.matrixAutoUpdate=!1},updateVisibility(e){this.el.object3D.visible=e},updateMatrix(e){e&&this.el.object3D.matrix.set(...e)}});const{Controller:o,UI:r}=window.MINDAR.FACE;AFRAME.registerSystem(e,{container:null,video:null,anchorEntities:[],faceMeshEntities:[],filterMinCF:-1/0,filterBeta:1/0,controller:null,ui:null,el:null,shouldFaceUser:!0,lastHasFace:!1,faceMeshPath:"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/",_positionSettings:"absolute",_positionZIndex:-2,init:function(){this.anchorEntities=[],this.faceMeshEntities=[]},setup:function({uiLoading:e,uiScanning:t,uiError:i,filterMinCF:s,filterBeta:a,shouldFaceUser:o,_positionSettings:l,_positionZIndex:h,faceMeshPath:d}){this.ui=new r({uiLoading:e,uiScanning:t,uiError:i}),this.filterMinCF=s,this.filterBeta=a,this.shouldFaceUser=o,this.faceMeshPath=d,n(l)||(this._positionSettings=l),n(h)||(this._positionZIndex=h)},registerFaceMesh:function(e){this.faceMeshEntities.push({el:e})},registerAnchor:function(e,t){this.anchorEntities.push({el:e,targetIndex:t})},start:function(){this.el.sceneEl&&this.el.sceneEl.parentNode&&(this.container=this.el.sceneEl.parentNode,this.ui.showLoading(),this._startVideo())},stop:function(){if(this.pause(),!this.video)return;const{srcObject:e}=this.video;e&&(e.getTracks().forEach((function(e){e.stop()})),this.video.remove())},switchCamera:function(){this.shouldFaceUser=!this.shouldFaceUser,this.stop(),this.start()},pause:function(e=!1){!e&&this.video&&this.video.pause(),this.controller&&this.controller.stopProcessVideo()},unpause:function(){this.video&&(this.video.play(),this.controller&&this.controller.processVideo(this.video))},_startVideo:async function(){if(this.video=document.createElement("video"),this.video.id="mindar-video",this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position=this._positionSettings,this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex=`${this._positionZIndex}`,this.container.appendChild(this.video),!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia))return this.el.emit(a,{error:"VIDEO_FAIL"}),void this.ui.showCompatibility();try{const s=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));let a="user";console.log("devices.length:",s.length),s.length>1&&(a=this.shouldFaceUser?"user":"environment");const n="user"==a?-1:1,o=`scaleX(${n})`;this.video.style.webkitTransform=o,this.video.style.transform=o;const r=this.container.getElementsByClassName("a-canvas")[0];r.style.transform=o,r.style.webkitTransform=o,console.log("facingMode:",a,n);const l=await(e={audio:!1,video:{facingMode:a}},navigator.mediaDevices.getUserMedia?(console.log("navigator",navigator),navigator.mediaDevices.getUserMedia(e)):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(e,t,i):navigator.mozGetUserMedia?navigator.mozGetUserMedia(e,t,i):navigator.getUserMedia?navigator.getUserMedia(e,t,i):Promise.reject());this.video.addEventListener("loadedmetadata",(async()=>{this.video.setAttribute("width",this.video.videoWidth.toString()),this.video.setAttribute("height",this.video.videoHeight.toString()),await this._setupAR(),this._processVideo(),this.ui.hideLoading()})),this.video.srcObject=l}catch(e){console.log("getUserMedia error",e),this.el.emit(a,{error:"VIDEO_FAIL"})}var e,t,i},_processVideo:function(){this.controller.onUpdate=({hasFace:e,estimateResult:t})=>{if(e&&!this.lastHasFace&&this.el.emit("face-targetFound"),!e&&this.lastHasFace&&this.el.emit("face-targetLost"),this.lastHasFace=!!e,e&&t){const{faceMatrix:e}=t;for(let e=0;e<this.anchorEntities.length;e++){const t=this.controller.getLandmarkMatrix(this.anchorEntities[e].targetIndex);this.anchorEntities[e].el.updateVisibility(!0),this.anchorEntities[e].el.updateMatrix(t)}for(let t=0;t<this.faceMeshEntities.length;t++)this.faceMeshEntities[t].el.updateVisibility(!0),this.faceMeshEntities[t].el.updateMatrix(e)}else{for(let e=0;e<this.anchorEntities.length;e++)this.anchorEntities[e].el.updateVisibility(!1);for(let e=0;e<this.faceMeshEntities.length;e++)this.faceMeshEntities[e].el.updateVisibility(!1)}},this.controller.processVideo(this.video)},_setupAR:async function(){this.controller=new o({filterMinCF:this.filterMinCF,filterBeta:this.filterBeta}),this._resize(),await this.controller.setup(this.video,this.faceMeshPath),await this.controller.dummyRun(this.video);const{fov:e,aspect:t,near:s,far:a}=this.controller.getCameraParams(),n=new AFRAME.THREE.PerspectiveCamera;n.fov=e,n.aspect=t,n.near=s,n.far=a,n.updateProjectionMatrix();const r=this.container.getElementsByTagName("a-camera")[0];r.setObject3D(i,n),r.setAttribute(i,"active",!0);for(let e=0;e<this.faceMeshEntities.length;e++)this.faceMeshEntities[e].el.addFaceMesh(this.controller.createThreeFaceGeometry());this._resize(),window.addEventListener("resize",this._resize.bind(this)),this.el.emit("arReady")},_resize:function(){((e,t)=>{let i,s;const a=e.videoWidth/e.videoHeight;a>t.clientWidth/t.clientHeight?(s=t.clientHeight,i=s*a):(i=t.clientWidth,s=i/a),e.style.top=-(s-t.clientHeight)/2+"px",e.style.left=-(i-t.clientWidth)/2+"px",e.style.width=i+"px",e.style.height=s+"px"})(this.video,this.container);const e=this.container.getElementsByTagName("a-scene")[0];e.style.top=this.video.style.top,e.style.left=this.video.style.left,e.style.width=this.video.style.width,e.style.height=this.video.style.height}})})();